---
// IMPORT COMPONENTS
import TmPost from './TmPost.astro';

// IMPORT TYPES
import { type MediaDatum } from './../types/posts';

// IMPORT ALL POSTS
import allPosts from './../../public/json/igPosts.json';
const igPostsLimit = 4;
const totalPosts: MediaDatum[] = allPosts.slice(0, igPostsLimit) as MediaDatum[];

// GET ASTRO PROPS
const { locale, language } = Astro.props;

// IMPORT DICTIONARY
import { getDictionary } from '../locales/getDictionary';
const dictionary = getDictionary(language);
---

{
  totalPosts.map((post, count) => {
    if (count < 3) {
      return (
        <article class="post">
          <TmPost
            locale={locale}
            timestamp={post.timestamp}
            permalink={post.permalink}
            media={post.children ? post.children.data : post.media_url}
            caption={post.caption}
            type={post.media_type}
            id={post.id}
            title={post.title}
            language={language}
            aspect_ratio={post.aspect_ratio}
          />
        </article>
      );
    } else if (count === 3) {
      return (
        <>
          <article class="post">
            <TmPost
              locale={locale}
              timestamp={post.timestamp}
              permalink={post.permalink}
              media={post.children ? post.children.data : post.media_url}
              caption={post.caption}
              type={post.media_type}
              id={post.id}
              title={post.title}
              language={language}
              aspect_ratio={post.aspect_ratio}
            />
          </article>
          <div id="navigationButtons">
            <button id="moreNews">{dictionary.Common.moreNews}</button>
            <button id="closeNews" style="display: none;">
              {dictionary.Common.closeNews}
            </button>
          </div>
        </>
      );
    }
  })
}
<script is:inline defer>
  const createDivElement = () => {
    const div = document.createElement('article');
    div.className = 'post';
    div.style.margin = '10px 0';
    return div;
  };

  const createAElement = (post) => {
    const a = document.createElement('a');
    a.innerText = `${new Date(post.timestamp).toLocaleDateString()} - IG POST`;
    a.href = post.permalink;
    a.target = '_blank';
    a.style.color = 'purple';
    a.style.fontWeight = 'bold';
    return a;
  };

  const createSpanElement = (post) => {
    const span = document.createElement('span');
    const timestamp = new Date(post.timestamp).toLocaleDateString();
    const title = post.title;
    const separator = title !== '' ? ' - ' : '';
    span.innerText = `${timestamp}${separator}${title}`;
    span.innerText = `${new Date(post.timestamp).toLocaleDateString()} ${separator} ${post.title}`;
    span.style.color = 'black';
    span.style.fontWeight = 'bold';
    return span;
  };

  const createPElement = (post) => {
    const p = document.createElement('p');
    p.innerText = post.caption;
    return p;
  };

  const createImgElement = (post) => {
    const img = document.createElement('img');
    location.pathname.length > 1 ? (img.src = `../${post.media_url}`) : (img.src = post.media_url);
    img.alt = post.id ? post.id : post.title ? post.title : 'alt';
    img.style.width = '100%';
    img.style.aspectRatio = post.aspect_ratio;
    return img;
  };

  const createVideoElement = (post) => {
    const video = document.createElement('video');
    video.src = post.media_url;
    video.controls = true;
    video.style.width = '100%';
    return video;
  };

  const createPostElement = (post) => {
    const div = createDivElement();
    if (!post.title) {
      const a = createAElement(post);
      div.appendChild(a);
    } else {
      const span = createSpanElement(post);
      div.appendChild(span);
    }
    if (post.caption) {
      const p = createPElement(post);
      div.appendChild(p);
    }
    if (post.media_url) {
      if (post.media_type === 'IMAGE') {
        const img = createImgElement(post);
        div.appendChild(img);
      } else if (post.media_type === 'VIDEO') {
        const video = createVideoElement(post);
        div.appendChild(video);
      } else if (post.media_type === 'CAROUSEL_ALBUM') {
        post.children.data.map((child) => {
          if (child.media_type === 'IMAGE') {
            const img = createImgElement(child);
            div.appendChild(img);
          } else if (child.media_type === 'VIDEO') {
            const video = createVideoElement(child);
            div.appendChild(video);
          }
        });
      }
    }
    return div;
  };

  const addMoreNews = (posts, length) => {
    posts.map((post) => {
      const postElement = createPostElement(post);
      document
        .getElementById('news')
        ?.insertBefore(postElement, document.getElementById('navigationButtons'));
      if (document.getElementsByClassName('post').length > 4) {
        showButton('closeNews');
      } else {
        hideButton('closeNews');
      }
      if (length === document.getElementsByClassName('post').length) {
        hideButton('moreNews');
      }
    });
  };

  const moreNewsButton = document.getElementById('moreNews');
  if (moreNewsButton)
    moreNewsButton.onclick = async () => {
      const jsonPosts = await getJsonPosts();
      addMoreNews(jsonPosts.posts, jsonPosts.length);
    };

  const closeNews = () => {
    removePosts();
    hideButton('closeNews');
    showButton('moreNews');
  };
  const closeNewsButton = document.getElementById('closeNews');
  if (closeNewsButton)
    closeNewsButton.onclick = () => {
      closeNews();
    };

  const hideButton = (buttonId) => {
    const button = document.getElementById(buttonId);
    if (button) button.style.display = 'none';
  };

  const showButton = (buttonId) => {
    const button = document.getElementById(buttonId);
    if (button) button.style.display = 'block';
  };

  const getJsonPosts = async () => {
    let data;
    if (localStorage.getItem('igPosts')) {
      data = JSON.parse(localStorage.getItem('igPosts'));
    } else {
      const jsonPath = location.pathname.length > 1 ? '../json/igPosts.json' : 'json/igPosts.json';
      const response = await fetch(jsonPath);
      data = await response.json();
      localStorage.setItem('igPosts', JSON.stringify(data));
    }
    const posts = document.getElementsByClassName('post');
    const dataToAppend = data.slice(posts.length, posts.length + 4);
    return { posts: dataToAppend, length: data.length };
  };

  window.onbeforeunload = () => {
    localStorage.removeItem('igPosts');
  };

  const removePosts = () => {
    const posts = document.getElementsByClassName('post');
    for (let i = posts.length - 1; i > 3; i--) {
      posts[i].remove();
    }
  };
</script>

<style>
  button {
    border-color: black;
    border-radius: 6px;
    color: black;
    font-size: 15px;
    margin: 10px 0;
    padding: 10px;
    width: 100%;
  }

  .post {
    margin: 10px 0;
  }
</style>
